<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Filter.as</title>
<link rel="stylesheet" type="text/css" href="../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">wcmc</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">classes</span>
<span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">events</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">Event</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">net</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">SharedObject</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">net</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">URLLoader</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">net</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">URLRequest</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">mx</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">collections</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">ArrayCollection</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">mx</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">core</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">IFactory</span>;
    <span class="ActionScriptASDoc">/**
     * The Filter Class is used to filter data from a relational database on the client and is used to generate the SQL statement that will be run against the RDBMS. Each Filter object specifies information about the table, primary and foreign keys and other information that will be used to return the matching data from the RDBMS. Filter Classes can be added to a FilterCollection object to combine multiple filter criteria.
     * @author andrewcottam
     * @example The following code creates a filter for a country:
     * &amp;lt;listing version="3.0"&amp;gt;
     * &amp;lt;classes:Filter id="country" label="Country" table="COUNTRY" valueField="Code" masterTableFilterFieldName="SiteRecID" filterRenderer="wcmc.renderers.CountryFilterRenderer" sortLookupValues="false"/&amp;gt;
     * &amp;lt;/listing&amp;gt;
     */</span>    
    <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"whereClauseSet"</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">type</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">"flash.events.Event"</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">]</span>
    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">Filter</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">Filter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>
        <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_fromClause</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * The masterTableFilterFieldName is the name of the field in the master table that is used to filter the data in the master table
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_sharedObjectName</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_whereClause</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptASDoc">/**
         * Flag to determine how the lookup values are returned. If sortLookupValues is false the data are returned in the default table order. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sortLookupValues</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * Flag to indicate that lookup values have been returned from the server.
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lookupValuesReturned</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * Flag to indicate if the filter is empty.
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">filterEmpty</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptASDoc">/**
         * Flag to indicate if this filter can be cleared. For a species page all data will be filtered by species and we do not want the filter to be cleared when clearAll is run on the filter collection. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">cannotClear</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>;
        <span class="ActionScriptASDoc">/**
         * Flag to indicate if the filter has changed when it is saved. 
         */</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">readableFilterString</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">urlRequest</span>:<span class="ActionScriptDefault_Text">URLRequest</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">URLRequest</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">urlLoader</span>:<span class="ActionScriptDefault_Text">URLLoader</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">URLLoader</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptASDoc">/**
         * An array of the id values of all of the selected items in the lookup values. This is set when the filter is saved. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">selectedItems</span>:<span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptASDoc">/**
         * The table that the filter will use to show the lookup values and filter the data. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">table</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptASDoc">/**
         * The field name in the table that will provide the values in the lookupValues array. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">valueField</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">readableTableName</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptASDoc">/**
         * A pointer to the FilterCollection that this filter belongs to.
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">filterCollection</span>:<span class="ActionScriptDefault_Text">FilterCollection</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * The class that will be used to render the lookupValues in any dialog box. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">filterRenderer</span>:<span class="ActionScriptDefault_Text">IFactory</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * The label that will be used in any UI for this filter. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">label</span>:<span class="ActionScriptDefault_Text">String</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * An ArrayCollection of the values that are returned when a call to get lookup values is made. These lookup values will be filtered by all of the filters in the filterCollection.
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lookupValues</span>:<span class="ActionScriptDefault_Text">ArrayCollection</span>;
        <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptMetadata">Bindable</span><span class="ActionScriptBracket/Brace">]</span>
        <span class="ActionScriptASDoc">/**
         * A flag to indicate if this filter is currently filtering any data at all or if all siteRecIDs are returned from the &amp;lt;table&amp;gt;_LINK table. The filterCollection object has a filtered property which flags if there are any active filters within the collection. 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">filtered</span>:<span class="ActionScriptDefault_Text">Boolean</span>;
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">sharedObjectName</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">String</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">_sharedObjectName</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">_sharedObjectName</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_filter"</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_sharedObjectName</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">set</span> <span class="ActionScriptDefault_Text">sharedObjectName</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">value</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">_sharedObjectName</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">value</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * The SQL where clause for this individual filter. This is null unless one of more items are selected from lookupValues (but null if all items are selected). This is set when the filter is saved.
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">String</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_whereClause</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @private
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">set</span> <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">value</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">_whereClause</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">value</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"whereClauseSet"</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * The SQL from clause for this individual filter. This is null unless one of more items are selected from lookupValues (but null if all items are selected). This is set when the filter is saved.
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">String</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_fromClause</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @private
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">set</span> <span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">value</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">_fromClause</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">value</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Returns the lookup values that can be used to populate any UI components. 
         * 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getLookupValues</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">lookupValuesReturned</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">sql</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">getLookupSQL</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//get the SQL statement to run on the server to return a set of lookup values
</span>            <span class="ActionScriptDefault_Text">urlLoader</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">COMPLETE</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">_lookupValuesReturned</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//create a listener to handle the asynchronous callback
</span>            <span class="ActionScriptDefault_Text">createURLRequest</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sql</span><span class="ActionScriptOperator">,</span><span class="ActionScriptString">"GetLookupValues"</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//create the request and call it
</span>        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * Returns the SQL statement to run on the server to return a set of lookup values 
         * @return SQL Statement
         * 
         */</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getLookupSQL</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">String</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">whereClause</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">""</span>; <span class="ActionScriptComment">//initialise variables to empty strings
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">fromClause</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">""</span>;
            <span class="ActionScriptReserved">for each</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">filter</span>:<span class="ActionScriptDefault_Text">Filter</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">filters</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//iterate through all of the other filters to build the where and from clauses according to whether other filters will constrain the lookup values that are returned
</span>            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">filter</span><span class="ActionScriptOperator">!==</span><span class="ActionScriptReserved">this</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//only build the from and where clauses from other filters, not this one
</span>                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">filter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">!=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">whereClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">whereClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" AND "</span>;
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">filter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptOperator">!=</span><span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">fromClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filter</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">fromClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" "</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">substr</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span>5<span class="ActionScriptBracket/Brace">)</span>; 
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">==</span><span class="ActionScriptString">""</span><span class="ActionScriptBracket/Brace">)</span> 
            <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">//if there are no other filters active then get all of the values from the table
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sortLookupValues</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">//sort the values if specified
</span>                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptString">"SELECT DISTINCT "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID AS 'r/@id', "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">valueField</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" AS 'r/@val' FROM "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" ORDER BY "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">valueField</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" FOR XML PATH(''), ROOT('rows')"</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptString">"SELECT DISTINCT "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID AS 'r/@id', "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">valueField</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" AS 'r/@val' FROM "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" FOR XML PATH(''), ROOT('rows')"</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">else</span>
            <span class="ActionScriptBracket/Brace">{</span> <span class="ActionScriptComment">//if there are other filters active then create the SQL statement using their combined where and from clauses
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sortLookupValues</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptString">"SELECT DISTINCT "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID AS 'r/@id', "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">valueField</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" AS 'r/@val' FROM "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" INNER JOIN "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK ON "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID ="</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID INNER JOIN "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">masterTableName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" ON "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" = "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">masterTableName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">fromClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" WHERE "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">whereClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" ORDER BY "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">valueField</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" FOR XML PATH(''), ROOT('rows')"</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptString">"SELECT DISTINCT "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID AS 'r/@id', "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">valueField</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" AS 'r/@val' FROM "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" INNER JOIN "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK ON "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID ="</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID INNER JOIN "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">masterTableName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" ON "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" = "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">masterTableName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">fromClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" WHERE "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">whereClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" FOR XML PATH(''), ROOT('rows')"</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * Asynchronous return call that populates the set of lookup values that are used in any UI components. 
         * @param event
         * 
         */</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">_lookupValuesReturned</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span>:<span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">urlLoader</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">removeEventListener</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">COMPLETE</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">_lookupValuesReturned</span><span class="ActionScriptBracket/Brace">)</span>; 
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xml</span>:<span class="ActionScriptDefault_Text">XML</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">XML</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">urlLoader</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//create a new XML object with the returned data 
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_lookupValues</span>:<span class="ActionScriptDefault_Text">ArrayCollection</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ArrayCollection</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//initialise a new array collection to hold the lookup values
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">selectAll</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptOperator">=</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">selectedItems</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">==</span>0<span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">||</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">filtered</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//select all values if no items are selected or if no filters are active
</span>            <span class="ActionScriptReserved">for each</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xml2</span>:<span class="ActionScriptDefault_Text">XML</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">xml</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">children</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//iterate through the XML nodes
</span>            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lookupValue</span>:<span class="ActionScriptDefault_Text">LookupValue</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">LookupValue</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//instantiate a new lookup value - this is used in the lookup value renderer to render the UI
</span>                <span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">xml2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">attribute</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">'id'</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//unique identifier for the lookup value - this is the primary key from the &amp;lt;table&amp;gt; table
</span>                <span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">xml2</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">attribute</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">'val'</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//the value that will be displayed in any UI
</span>                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">selectAll</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">?</span> <span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">selected</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span> : <span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">selected</span><span class="ActionScriptOperator">=</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">selectedItems</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">indexOf</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">&gt;=</span>0<span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//set the check box as selected if the value is currently in the filter, or all selected if there are no current selected items
</span>                <span class="ActionScriptDefault_Text">_lookupValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addItem</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//add the lookup value
</span>            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">_lookupValues</span>; <span class="ActionScriptComment">//set the lookup values
</span>            <span class="ActionScriptDefault_Text">lookupValuesReturned</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"lookupValuesReturned"</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//fire the event
</span>        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * Simple method to create the url request and call it 
         * @param sql
         * @param method
         * 
         */</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">createURLRequest</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sql</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">method</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptDefault_Text">urlRequest</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">url</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">"http://dev.unep-wcmc.org/CSN_WebServices/DataServices.asmx/"</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">method</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"?sql="</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">sql</span>;
            <span class="ActionScriptDefault_Text">urlLoader</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">load</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">urlRequest</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">save</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">inClause</span>:<span class="ActionScriptDefault_Text">String</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">""</span>; <span class="ActionScriptComment">//initialise to empty string
</span>            <span class="ActionScriptDefault_Text">clear</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//resets the filter variables without saving
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptReserved">for each</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lookupValue</span>:<span class="ActionScriptDefault_Text">LookupValue</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//iterate through the lookup values and build the inclause that will be used in the SQL statement based on if the lookup value is selected or not
</span>            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">selected</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//if the lookup value is selected
</span>                <span class="ActionScriptBracket/Brace">{</span> 
                    <span class="ActionScriptDefault_Text">inClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">inClause</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">","</span>;
                    <span class="ActionScriptDefault_Text">selectedItems</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">push</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//add the selected lookup values id to the selectedItems array
</span>                    <span class="ActionScriptDefault_Text">readableFilterString</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">readableFilterString</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">lookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">", "</span> ;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">switch</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">selectedItems</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//take action depending on what is selected in this filter
</span>            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">case</span> 0: <span class="ActionScriptComment">//nothing selected - fire an event and exit
</span>                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">&gt;</span>0<span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">filterEmpty</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span>;
                        <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"filterEmptyEvent"</span><span class="ActionScriptOperator">,</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptReserved">return</span>;
                    <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">case</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">)</span>: <span class="ActionScriptComment">//everything selected - therefore this filter is not active - do nothing but keep the null default values for the where and from clauses so that this filter isnt used
</span>                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptReserved">break</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">default</span>: <span class="ActionScriptComment">//some items selected so create the from and where clauses for the filter
</span>                <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"ID IN ("</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">inClause</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">substr</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">inClause</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span>1<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">")"</span>;
                    <span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">"INNER JOIN "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK ON "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">table</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"_LINK."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">" = "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">filterCollection</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">masterTableName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"."</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">masterTableFilterFieldName</span>; <span class="ActionScriptComment">//e.g. COUNTRY_LINK INNER JOIN CSN_IBA ON COUNTRY_LINK.SiteRecID = CSN_IBA.SiteRecID
</span>                    <span class="ActionScriptDefault_Text">readableFilterString</span><span class="ActionScriptOperator">=</span> <span class="ActionScriptString">"'"</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">readableTableName</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">"' filtered by: "</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">readableFilterString</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">substr</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">readableFilterString</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">length</span><span class="ActionScriptOperator">-</span>2<span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptDefault_Text">filtered</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">true</span>;
                    <span class="ActionScriptReserved">break</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">saveToSharedObject</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//save the filter to the shared object
</span>        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * Persists the filter to a shared object 
         * 
         */</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">saveToSharedObject</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">mySO</span>:<span class="ActionScriptDefault_Text">SharedObject</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">SharedObject</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">getLocal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">sharedObjectName</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptOperator">==</span><span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">&amp;&amp;</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">==</span><span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">//only save the data if the filter has changed
</span>            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">selectedItems</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">selectedItems</span>;
                <span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">fromClause</span>;
                <span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">whereClause</span>;
                <span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">data</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">filtered</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">filtered</span>;
                <span class="ActionScriptDefault_Text">mySO</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">flush</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">dispatchEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Event</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">"filterSavedEvent"</span><span class="ActionScriptOperator">,</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//fire an event
</span>            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * Clears the filter and optionally saves it 
         * 
         */</span>        
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">clear</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">save</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">cannotClear</span><span class="ActionScriptBracket/Brace">)</span>
            <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">readableFilterString</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">""</span>;
                <span class="ActionScriptDefault_Text">whereClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>;
                <span class="ActionScriptDefault_Text">fromClause</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">null</span>;
                <span class="ActionScriptDefault_Text">filterEmpty</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptDefault_Text">selectedItems</span><span class="ActionScriptOperator">=</span>[]; <span class="ActionScriptComment">//empty the selected items array
</span>                <span class="ActionScriptDefault_Text">filtered</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>; <span class="ActionScriptComment">//default value
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">save</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">saveToSharedObject</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//save the filter to the shared object
</span>            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">setProgrammatically</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">selectedValues</span>:<span class="ActionScriptDefault_Text">ArrayCollection</span><span class="ActionScriptOperator">,</span><span class="ActionScriptDefault_Text">cannotClear</span>:<span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptReserved">void</span>
        <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptOperator">!</span><span class="ActionScriptDefault_Text">selectedValues</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptDefault_Text">clear</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//may have been initialised from a stored object so clear it before setting it programmatically
</span>            <span class="ActionScriptReserved">this</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">cannotClear</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">cannotClear</span>;
            <span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">selectedValues</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">dummyLookupValue</span>:<span class="ActionScriptDefault_Text">LookupValue</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">LookupValue</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//required to avoid the 'case (lookupValues.length)' switch in the Save function
</span>            <span class="ActionScriptDefault_Text">dummyLookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">id</span><span class="ActionScriptOperator">=</span>-1;
            <span class="ActionScriptDefault_Text">dummyLookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">selected</span><span class="ActionScriptOperator">=</span><span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptDefault_Text">dummyLookupValue</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">value</span><span class="ActionScriptOperator">=</span><span class="ActionScriptString">""</span>;
            <span class="ActionScriptDefault_Text">lookupValues</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">addItem</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">dummyLookupValue</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">save</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span>
</pre></body>
</html>
